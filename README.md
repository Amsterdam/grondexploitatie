# Grondexploitatie

API and import module

## development

* python 3.6 (required)
* virtualenv (recommended)
* docker-compose (recommended)


    virtualenv --python=`which python3` --prompt='GR->' venv
    source venv/bin/activate

### installation

install required modules

    cd src
    pip install -r requirements.txt
    cd ..

and possibly

    pip install git+https://github.com/amsterdam/objectstore.git
    

### start database

    docker-compose up database
    
### configure objectstore access

    export GRONDEXPLOITATIE_OBJECTSTORE_PASSWORD=<secret_password>
    
### import data

    cd src/import
    sh import.sh local
    cd ../..

The following files are retrieved from Objectstore:

* Mappingbestand rapportage baten.xlsx (eenmalig)
* dump-panos-4-12-2017.xlsx (1 x 3 mnd)
* grex_grenzen.tgz (1 x jaar)

The following processing steps are executed:
* MapInfo files are converted to PostGIS SQL dump files    
* SQL files are converted to utf-8 encoded SQL files
* GREX grenzen are imported in the database
* Excel data is imported in the database
* Some data problems are fixed  

### Generate Django models
Optional step    
 
    python manage.py inspectdb > grondexploitatie/models.py
    
### Tests

    cd src
    python manage.py test
    
### Run server 
 
    cd src
    python manage.py runserver
    
Then test  URLS like :
 
    http://localhost:8000/projects/
    http://localhost:8000/project/26015/?use_period_groups 
    http://localhost:8000/project/26015/?use_period_groups&start_jaar=2018

You have to pass authentication tokens with these URLS because the API is protected.

For local development you can use the mktoken.emplyee.local script :

    curl -H "Authorization: bearer `./mktoken.employee.local`" http://localhost:8000/grondexploitatie/projects/

For acceptation you can generate tokens with the mktoken.employee.acc script :

    curl -H "Authorization: bearer `./mktoken.employee.acc`" https://acc.api.data.amsterdam.nl/grondexploitatie/projects/

For production this can be done with the mktoken.employee script :

    curl -H "Authorization: bearer `./mktoken.employee`" https://api.data.amsterdam.nl/grondexploitatie/projects/

### Swagger UI & OpenAPI

There is a OpenAPI specification located at:

    https://acc.api.data.amsterdam.nl/grondexploitatie/api-docs/openapi.yml

This can be used together with the SwaggerUI in acceptation with :

    https://acc.api.data.amsterdam.nl/api/swagger/?url=https://acc.api.data.amsterdam.nl/grondexploitatie/api-docs/openapi.yml

Here the login buttons will work in the SwaggerUI with the datapunt authorization service and IDP, and it is
possible to test the login and try the the API with generated tokens.

 