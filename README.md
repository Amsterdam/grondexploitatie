# grondexploitatie

api and import module

## development

* python 3.6 (required)
* virtualenv (recommended)
* docker-compose (recommended)


    virtualenv --python=`which python3` --prompt='GR->' venv
    source venv/bin/activate

install required modules

    cd src
    pip install -r requirements.txt
    cd ..

and possibly

    pip install git+https://github.com/amsterdam/objectstore.git
    

### grondexploitatie import

    docker-compose up database
    export GRONDEXPLOITATE_OBJECTSTORE_PASSWORD=<secret_password>

    cd src
    mkdir -p data
    python download_objectstore_files.py
    
The following files are retrieved from [objectstore](./src/grondexploitatie/download_objectstore_files.py):

    Mappingbestand rapportage baten.xlsx (eenmalig)
    dump-panos-4-12-2017.xlsx (1 x 3 mnd)
    grex_grenzen.tgz (1 x jaar)

Convert MapInfo files to PostGIS SQL dump file    
    
    cd data
    tar xzvf grex_grenzen.tgz
    cd ..
    
    ogr2ogr -f "PGDump" data/GREX_grenzen_2016.sql data/grex_grenzen/GREX_grenzen_OGAGIS_2016.TAB
    
Convert SQL file to utf-8 SQL file:

    iconv -f iso-8859-1 -t utf-8  data/GREX_grenzen_2016.sql > data/GREX_grenzen_2016.utf8.sql

Import GREX grenzen in the database

    set -x && set -e && echo database:5404:grondexploitatie:grondexploitatie:insecure >> ~/.pgpass
    set +x
    chmod 600 ~/.pgpass
    
    cat data/GREX_grenzen_2016.utf8.sql | psql -h localhost -p 5404  -U grondexploitatie grondexploitatie
    
Fix data problems      
    
Import Excel data in the database
    
    python import_excel_data.py 
    
Fix data problems  

    cat fix_data.sql | psql -h localhost -p 5404  -U grondexploitatie grondexploitatie     
    
Generate Django models    
 
    python manage.py inspectdb > grondexploitatie/models.py
    
 Run server 
 
    python manage.py runserver
    
    
 Then test  URLS like :
 
    http://localhost:8000/projects/
    http://localhost:8000/project/26015/?use_period_groups 
    http://localhost:8000/project/26015/?use_period_groups&start_jaar=2018  
    
 