# Grondexploitatie

API and import module

## development

* python 3.6 (required)
* virtualenv (recommended)
* docker-compose (recommended)


    virtualenv --python=`which python3` --prompt='GR->' venv
    source venv/bin/activate

### installation

install required modules

    cd src
    pip install -r requirements.txt
    cd ..

and possibly

    pip install git+https://github.com/amsterdam/objectstore.git
    

### start database

    docker-compose up -d database
    
### restore database

`docker-compose exec database update-db.sh grondexploitatie <user>`

or import data with the following steps:

### get bag_stadsdeel tables

`docker-compose exec database download-db.sh bag <your username>
docker-compose exec database update-table.sh bag bag_stadsdeel public grondexploitatie`

### import grondexploitatie database

`docker-compose exec database update-db.sh grondexploitatie <your username>`

### configure objectstore access

    export GRONDEXPLOITATIE_OBJECTSTORE_PASSWORD=<secret_password>
    
### import data

    cd src/import
    sh import.sh local
    cd ../..

The following files are retrieved from Objectstore:

* Mappingbestand rapportage baten.xlsx (eenmalig)
* dump-planex.xlsx (1 x 3 mnd)
* grex_grenzen.tgz (1 x jaar)

The following processing steps are executed:
* MapInfo files are converted to PostGIS SQL dump files    
* SQL files are converted to utf-8 encoded SQL files
* GREX grenzen are imported in the database
* Excel data is imported in the database
* Some data problems are fixed  

### Generate Django models
Optional step, only needed when the database layout has changed:    
 
    python manage.py inspectdb > grondexploitatie/models.py
    
Remember to remove the default django tables **DjangoContentType** and **DjangoMigrations** classes and change the managed property of the other tables to:

    managed = True
    
### Tests
This requires the database to have been started ([start database](#start-database))

    cd src
    python manage.py test
    
### Run server 
 
    cd src
    python manage.py migrate
    python manage.py runserver
    
Then test  URLS like :
 
    http://localhost:8000/grondexploitatie/projects/
    http://localhost:8000/grondexploitatie/project/26015/ 
    http://localhost:8000/grondexploitatie/project/26015/
    http://localhost:8000/grondexploitatie/project/26015/?start_jaar=2018

You have to pass authentication tokens with these URLS because the API is protected.

For local development you can use the mktoken.emplyee.local script :

    curl -H "Authorization: bearer `./src/test/localauth/mktoken.employee.local`" http://localhost:8000/grondexploitatie/projects/
    
or run the requests in Postman while setting the Authorization Bearer token to the output of

    ./src/test/localauth/mktoken.employee.local

In the acceptance and production environment you can test the API endpoints using swagger:

* Acceptance: 
https://acc.api.data.amsterdam.nl/api/swagger/?url=/grondexploitatie/api-docs/openapi.yml

* Production: 
https://api.data.amsterdam.nl/api/swagger/?url=/grondexploitatie/api-docs/openapi.yml

Use the **Authorize** button in the swagger UI to require an authentication token.

### Swagger UI & OpenAPI

There is a OpenAPI specification located at:

* Acceptance: https://acc.api.data.amsterdam.nl/grondexploitatie/api-docs/openapi.yml
    
* Production: https://api.data.amsterdam.nl/grondexploitatie/api-docs/openapi.yml

This specification is used by the SwaggerUI, which can be accessed by using the links that have been mentioned in the [Run server](#run-server) paragraph.
