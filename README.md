# grondexploitatie

api and import module

## development

* python 3.6 (required)
* virtualenv (recommended)
* docker-compose (recommended)


    virtualenv --python=`which python3` --prompt='GR->' venv
    source venv/bin/activate

install required modules

    pip install -r requirements.txt

and possible 

    pip install git+https://github.com/amsterdam/objectstore.git
    

### grondexploitatie import 

    docker-compose up database 
    export grondexploitate_objectstore_password=<secret_password>
    cd src/grondexploitatie
    mkdir -p data
    python download_objectstore_files.py
    
Convert MapInfo files to PostGIS SQL dump file    
    
    cd data
    tar xzvf grex_grenzen.tgz
    cd ..
    
    ogr2ogr -f "PGDump" data/GREX_grenzen_2016.sql data/grex_grenzen/GREX_grenzen_OGAGIS_2016.TAB 
    
Convert SQL file to utf-8 SQL file:

    iconv -f iso-8859-1 -t utf-8  data/GREX_grenzen_2016.sql > data/GREX_grenzen_2016.utf8.sql

Import in the database 

    set -x && set -e && echo database:5404:grondexploitatie:grondexploitatie:insecure >> ~/.pgpass
    chmod 600 ~/.pgpass
    
    cat data/GREX_grenzen_2016.utf8.sql | psql -h localhost -p 5404  -U grondexploitatie grondexploitatie
    
    
    
Fix data problems      
    
    
fix data 

fix project_code


alter table planex add column plannr integer;
update planex set plannr = cast((regexp_matches("project_code", '^(\d{5})$'))[1] as integer)
create index plannr_idx on planex(plannr)
alter table grex_grenzen_ogagis_2016 alter column plannr type integer



python manage.py inspectdb > grondexploitatie/models.py

