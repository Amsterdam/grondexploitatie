#!/usr/bin/env bash

set -e   # stop on any error

# Allow for local and global execution (default)
EXEC_FOR=${1:-global}

set -u   # crash on missing env variables

if [ $EXEC_FOR = "local" ]
then
    # Define location for processing scripts
    export GRONDEXPLOITATIE_MAIN_DIR=`cd ..; pwd`
    # Define location for saving data files
    export GRONDEXPLOITATIE_DATA_DIR=${GRONDEXPLOITATIE_MAIN_DIR}/data/
    DATABASE_HOST=localhost
    DATABASE_PORT=5404
    DATABASE_NAME=grondexploitatie
    DATABASE_USER=grondexploitatie
    DATABASE_PASSWORD=insecure
else
    # Define location for processing scripts
    export GRONDEXPLOITATIE_MAIN_DIR=/app
    # Define location for saving data files
    export GRONDEXPLOITATIE_DATA_DIR=/tmp/data/
fi

export GRONDEXPLOITATIE_IMPORT_DIR=${GRONDEXPLOITATIE_MAIN_DIR}/import

echo "Main dir: $GRONDEXPLOITATIE_MAIN_DIR"
echo "Data dir: $GRONDEXPLOITATIE_DATA_DIR"

# Provide for a location to extract and process data files
mkdir -p $GRONDEXPLOITATIE_DATA_DIR

# The import scripts are located in the import folder
cd $GRONDEXPLOITATIE_IMPORT_DIR

# Download the data files
python download_objectstore_files.py

# Extract the data files
cd $GRONDEXPLOITATIE_DATA_DIR
tar xzvf grex_grenzen.tgz

# Convert MapInfo files to PostGIS SQL dump file
ogr2ogr -f "PGDump" ${GRONDEXPLOITATIE_DATA_DIR}GREX_grenzen_2016.sql \
                    ${GRONDEXPLOITATIE_DATA_DIR}grex_grenzen/GREX_grenzen_OGAGIS_2016.TAB

# Convert SQL file to utf-8 SQL file
iconv -f iso-8859-1 -t utf-8  ${GRONDEXPLOITATIE_DATA_DIR}GREX_grenzen_2016.sql \
                            > ${GRONDEXPLOITATIE_DATA_DIR}GREX_grenzen_2016.utf8.sql

# Register database credentials
echo ${DATABASE_HOST}:${DATABASE_PORT}:${DATABASE_NAME}:${DATABASE_USER}:${DATABASE_PASSWORD} >> ~/.pgpass
chmod 600 ~/.pgpass

# Import in the database
cat ${GRONDEXPLOITATIE_DATA_DIR}GREX_grenzen_2016.utf8.sql | \
    psql -h ${DATABASE_HOST} -p ${DATABASE_PORT} -U ${DATABASE_USER} ${DATABASE_NAME}

# Continue in main folder to import Excel data
cd $GRONDEXPLOITATIE_MAIN_DIR

# Import Excel data in the database
python import_excel_data.py

# Continue in import folder for data fixes
cd $GRONDEXPLOITATIE_IMPORT_DIR

# Fix data problems
cat fix_data.sql | \
    psql -h ${DATABASE_HOST} -p ${DATABASE_PORT} -U ${DATABASE_USER} ${DATABASE_NAME}
