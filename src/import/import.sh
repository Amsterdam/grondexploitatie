#!/usr/bin/env bash

set -u   # crash on missing env variables
set -e   # stop on any error

# Define location for saving data files
export GRONDEXPLOITATE_DATA_DIR=/tmp/data/
mkdir -p $GRONDEXPLOITATE_DATA_DIR

# The import scripts are located in the /app folder
cd /app

# Download the data files
python download_objectstore_files.py

# Extract the data files
cd $GRONDEXPLOITATE_DATA_DIR
tar xzvf grex_grenzen.tgz

# Convert MapInfo files to PostGIS SQL dump file
ogr2ogr -f "PGDump" ${GRONDEXPLOITATE_DATA_DIR}GREX_grenzen_2016.sql \
                    ${GRONDEXPLOITATE_DATA_DIR}grex_grenzen/GREX_grenzen_OGAGIS_2016.TAB

# Convert SQL file to utf-8 SQL file
iconv -f iso-8859-1 -t utf-8  ${GRONDEXPLOITATE_DATA_DIR}GREX_grenzen_2016.sql \
                            > ${GRONDEXPLOITATE_DATA_DIR}GREX_grenzen_2016.utf8.sql

# Register database credentials
echo ${DATABASE_HOST}:${DATABASE_PORT}:${DATABASE_NAME}:${DATABASE_USER}:${DATABASE_PASSWORD} >> ~/.pgpass
chmod 600 ~/.pgpass

# Import in the database
cat ${GRONDEXPLOITATE_DATA_DIR}GREX_grenzen_2016.utf8.sql | \
    psql -h ${DATABASE_HOST} -p ${DATABASE_PORT} -U ${DATABASE_USER} ${DATABASE_NAME}
