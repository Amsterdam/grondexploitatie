DROP TABLE IF EXISTS stadsdeel_begroot;
CREATE TABLE stadsdeel_begroot AS (
WITH all_plan_stadsdelen AS (
	SELECT g.plannr, g.plannaam, s.code, s.naam, ST_Area(ST_Intersection(s.geometrie, g.wkb_geometry) ) AS st_area
	FROM grex_grenzen g
	JOIN bag_stadsdeel s on ST_Intersects(s.geometrie, g.wkb_geometry)
  ),
	plan_stadsdelen AS (
	SELECT a.*
	FROM all_plan_stadsdelen a
	LEFT OUTER JOIN all_plan_stadsdelen b
    ON a.plannr = b.plannr AND a.st_area < b.st_area
	WHERE b.plannr IS NULL
	),
	begroot_stadsdeel AS (
	SELECT s.code, cast(SUM(p.nw_begroot) / 1000000 as integer) AS begroot
	FROM bag_stadsdeel s
	JOIN plan_stadsdelen a ON a.code = s.code
	JOIN planex p ON p.plannr = a.plannr
	JOIN mapping_rapportage m on m.cataloguspost = p.cataloguspost_nummer
	JOIN grex_grenzen g ON g.plannr = p.plannr
	WHERE p.kosten_baten = 'Baten'
	AND g.planstatus in ('A', 'T')
	GROUP BY s.code
	),
	max_begroot AS (
		SELECT MAX(begroot) AS max_begroot
		FROM begroot_stadsdeel
	)
SELECT st.code, st.naam, st.geometrie, coalesce(bs.begroot, 0) as begroot
	    ,CASE WHEN bs.begroot IS NULL THEN '#000000'
            ELSE '#' || LPAD(to_hex(bs.begroot * 255 / mb.max_begroot )::text, 2, '0') || '0000'
       END AS color_val
FROM bag_stadsdeel st
LEFT OUTER JOIN begroot_stadsdeel bs ON bs.code = st.code
	, max_begroot mb
);
