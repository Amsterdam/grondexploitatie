ALTER TABLE grex_grenzen ADD COLUMN stadsdeel_code CHARACTER VARYING(3);

WITH all_plan_stadsdelen AS (
	SELECT g.plannr, g.plannaam, s.code, s.naam, ST_Area(ST_Intersection(s.geometrie, g.wkb_geometry) ) AS st_area
	FROM grex_grenzen g
	JOIN bag_stadsdeel s on ST_Intersects(s.geometrie, g.wkb_geometry)
  ),
	plan_stadsdelen AS (
	SELECT a.*
	FROM all_plan_stadsdelen a
	LEFT OUTER JOIN all_plan_stadsdelen b
    ON a.plannr = b.plannr AND a.st_area < b.st_area
	WHERE b.plannr IS NULL
	)
UPDATE grex_grenzen g
SET stadsdeel_code = plan_stadsdelen.code
FROM plan_stadsdelen
WHERE plan_stadsdelen.plannr = g.plannr;

DROP TABLE IF EXISTS stadsdeel_begroot CASCADE;

CREATE TABLE stadsdeel_begroot AS (
WITH  begroot_stadsdeel AS (
	SELECT s.code, cast(SUM(p.nw_begroot) / 1000000 as integer) AS begroot
	FROM bag_stadsdeel s
	JOIN grex_grenzen g ON g.stadsdeel_code = s.code
	JOIN planex p ON p.plannr = g.plannr
	JOIN mapping_rapportage m on m.cataloguspost = p.cataloguspost_nummer
	WHERE p.kosten_baten = 'Baten'
	AND g.planstatus in ('A', 'T')
	AND m.rapportagepost IS NOT NULL
	GROUP BY s.code
	),
	max_begroot AS (
		SELECT MAX(begroot) AS max_begroot
		FROM begroot_stadsdeel
	)
SELECT st.code, st.naam, st.geometrie, coalesce(bs.begroot, 0) as begroot
	    ,CASE WHEN bs.begroot IS NULL THEN '#000000'
            ELSE '#' || LPAD(to_hex(bs.begroot * 255 / mb.max_begroot )::text, 2, '0') || '0000'
       END AS color_val
FROM bag_stadsdeel st
LEFT OUTER JOIN begroot_stadsdeel bs ON bs.code = st.code
	, max_begroot mb
);

CREATE VIEW stadsdeel_begroot_display AS
WITH max_begroot AS (
		SELECT MAX(begroot) AS max_begroot
		FROM stadsdeel_begroot
	)
SELECT sb.code, sb.naam, sb.geometrie, sb.begroot,
    -- Create a range from white to blue as color #ffffff to #004699  or 255 255 255 to 0 70 153
    '#' || LPAD(TO_HEX(255 - sb.begroot * 255 / mb.max_begroot )::text, 2, '0')
    || LPAD(TO_HEX(255 - sb.begroot *  185 / mb.max_begroot )::text, 2, '0')
    || LPAD(TO_HEX(255 - sb.begroot *  102 / mb.max_begroot )::text, 2, '0') AS color_val
  , concat(E'\u20AC', ' ', cast(sb.begroot as character varying(10)), ' ', 'mil.') as begroot_display
FROM stadsdeel_begroot sb, max_begroot mb;
