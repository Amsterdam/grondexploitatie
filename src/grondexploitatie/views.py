import re
import datetime
import logging
import json
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.reverse import reverse
from django.http import JsonResponse
from django.db import connection

from rest_framework.status import HTTP_400_BAD_REQUEST, HTTP_404_NOT_FOUND

log = logging.getLogger(__name__)


def get_start_jaar(request):
    now = datetime.datetime.now()
    current_year = now.year
    if 'start_jaar' in request.query_params:
        start_jaar = request.query_params['start_jaar']
        start_jaar = int(start_jaar)
        if not 1900 <= start_jaar <= current_year + 5:
            raise ValueError
    else:
        start_jaar = current_year
    return start_jaar


class ProjectList(APIView):
    def get(self, request):
        """
        Geef lijst van alle projecten waarvoor er baten zijn vanaf het 'start_jaar'
        Default is 'start_jaar' het huidige jaar
        """
        try:
            start_jaar = get_start_jaar(request)
        except ValueError:
            return Response(status=HTTP_400_BAD_REQUEST)

        sql = '''select g.plannr as project
        , g.plannaam as naam
        from grex_grenzen g
        join planex p on g.plannr = p.plannr
        where p.kosten_baten = 'Baten'
        and p.periode >= %s
        group by 1,2 order by 1,2
        '''
        results = []
        with connection.cursor() as cursor:
            cursor.execute(sql, [start_jaar])
            for row in cursor.fetchall():
                (plannr, plannaam) = row
                href = reverse('project_detail', kwargs=dict(plannr=plannr), request=request)
                results.append({
                    'plannr': plannr,
                    'plannaam': plannaam,
                    '_links': {
                        'self': {
                            'href': href
                        }
                    }
                })

        data = {
            "count": len(results),
            "results": results,
        }

        return JsonResponse(data)


class ProjectDetail(APIView):
    """
    Toon details voor project met baten begroot per categorie vanaf 'start_jaar'
    Default is 'start_jaar' het huidige jaar
    """

    def get(self, request, plannr):  # noqa C901
        if not re.match('^\d{5}$', plannr):
            # This should never occur, see url spec in urls.py
            return Response(status=HTTP_400_BAD_REQUEST)

        try:
            start_jaar = get_start_jaar(request)
        except ValueError:
            return Response(status=HTTP_400_BAD_REQUEST)

        sqlplan = '''select g.plannr as project
                , g.plannaam as naam
                , g.startdatum as startdatum
                , g.planstatus as status
                , ST_AsGeoJSON(g.wkb_geometry) as geometrie
        from grex_grenzen g
        where g.plannr = %s and g.planstatus in ('A', 'T')
        order by g.planstatus
        '''

        with connection.cursor() as cursor:
            cursor.execute(sqlplan, [plannr])
            row = cursor.fetchone()
            if row is None:
                return Response(status=HTTP_404_NOT_FOUND)

            (plannr, plannaam, startdatum, planstatus, geometrie) = row
            geometrie = json.loads(geometrie)

            data = {
                'plannr': plannr,
                'plannaam': plannaam,
                'startdatum': startdatum,
                'planstatus': planstatus,
                'geometrie': geometrie,
                '_display': plannaam,
                'startjaar': start_jaar,
            }

            sql = '''select p.plannr as project
    , p.begroting_naam as begroting
    , p.prijspeildatum as prijspeildatum
    , m.rapportagepost as categorie
    , p.periode as periode
    , p.fase as fase
    , sum(p.nw_begroot) as begroot
    from planex p
    join mapping_rapportage m on m.cataloguspost = cast(p.cataloguspost_nummer as double precision)
    where p.plannr = %s
        and p.kosten_baten = 'Baten'
    group by p.plannr
        , p.begroting_naam
        , p.prijspeildatum
        , m.rapportagepost
        , p.periode
        , p.fase
        order by 1, 2
        '''

            period_bucket_size = 4
            cursor.execute(sql, [plannr])
            for row in cursor.fetchall():
                (plannr, begroting, prijspeildatum, categorie, periode, fase, begroot) = row
                periode = int(periode) if periode else None
                if 'begroting' not in data:
                    data['begroting'] = begroting
                if 'prijspeildatum' not in data:
                    data['prijspeildatum'] = prijspeildatum
                if 'fase' not in data:
                    data['fase'] = fase
                if not (begroting == data['begroting'] and
                        prijspeildatum == data['prijspeildatum'] and
                        fase == data['fase']):
                    log.error("Wrong values in row {}".format(row))

                if periode is None or periode < start_jaar:
                    continue

                if categorie is not None:
                    if 'begroot' not in data:
                        data['begroot'] = dict()

                    # Compute per period in begroot
                    # We will group in buckets of the current year and then in periods of four years
                    if periode == start_jaar:
                        bucket_name = str(periode) + '-' + str(periode)
                    else:
                        bucket = int((periode - (start_jaar + 1)) / period_bucket_size)
                        start_bucket_jaar = (start_jaar + 1) + period_bucket_size * bucket
                        end_bucket_jaar = start_bucket_jaar + period_bucket_size - 1
                        bucket_name = str(start_bucket_jaar) + '-' + str(end_bucket_jaar)
                    if categorie not in data['begroot']:
                        data['begroot'][categorie] = dict()
                    if bucket_name not in data['begroot'][categorie]:
                        data['begroot'][categorie][bucket_name] = 0
                    data['begroot'][categorie][bucket_name] += begroot

                    # Compute totaal
                    if 'totaal' not in data['begroot'][categorie]:
                        data['begroot'][categorie]['totaal'] = {
                            'begroot': 0,
                            'start': str(start_jaar),
                            'end': str(start_jaar)
                        }
                    data['begroot'][categorie]['totaal']['begroot'] += begroot
                    if periode > int(data['begroot'][categorie]['totaal']['end']):
                        data['begroot'][categorie]['totaal']['end'] = str(periode)

        if 'prijspeildatum' not in data:
            data['prijspeildatum'] = None
        if 'fase' not in data:
            data['fase'] = None
        if 'begroting' not in data:
            data['begroting'] = None
        if 'begroot' not in data:
            data['begroot'] = None
        else:
            list_categories = []
            for categorie in data['begroot']:
                list_periods = []
                for bucket_name in data['begroot'][categorie]:
                    if bucket_name == 'totaal':
                        continue
                    start = bucket_name[:4]
                    end = bucket_name[5:]
                    period_entry = {
                        'start': start,
                        'end': end,
                        'begroot': int(data['begroot'][categorie][bucket_name])
                    }
                    list_periods.append(period_entry)
                data['begroot'][categorie]['totaal']['begroot'] = int(data['begroot'][categorie]['totaal']['begroot'])
                category_entry = {
                    'categorie': categorie,
                    'jaren': list_periods,
                    'totaal': data['begroot'][categorie]['totaal']
                }
                list_categories.append(category_entry)

            data['begroot'] = list_categories

        return JsonResponse(data)
